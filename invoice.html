<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>Shans System - Invoice</title>
    <style>
        /* Basic Reset */
        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }
    
        /* Body Styling */
        body {
          font-family: Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          background-color: #f4f4f4;
          padding: 20px;
          /* Allow horizontal scrolling on very small devices */
          overflow-x: auto;
        }
    
        /* Container with a fixed 800px width to preserve the layout */
        .container {
          width: 800px;
          margin: 0 auto;
          background: white;
          padding: 20px;
          box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    
        /* Header */
        .header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 20px;
        }
    
        .logo {
          width: 100px;
          height: 100px;
          border-radius: 50%;
          background-image: url('./Assets/logo.png');
          background-position: center;
          background-size: cover;
          background-repeat: no-repeat;
        }
    
        h1 {
          text-align: center;
          flex-grow: 1;
          margin: 0 20px;
          font-size: 32px;
        }
    
        /* Company Details */
        .company-details {
          margin-bottom: 20px;
        }
    
        .company-details h2 {
          margin-bottom: 10px;
          font-size: 24px;
        }
    
        .address-contact {
          margin-bottom: 10px;
        }
    
        /* Reference Number */
        .reference-number {
          margin-top: 10px;
          font-size: 16px;
          font-weight: bold;
        }
    
        /* Billing and Shipping */
        .billing-shipping {
          display: flex;
          justify-content: space-between;
          margin-bottom: 20px;
          flex-wrap: wrap;
        }
    
        .billing,
        .shipping {
          flex-basis: 48%;
          margin-bottom: 20px;
        }
    
        .billing h3,
        .shipping h3 {
          margin-bottom: 10px;
          font-size: 20px;
          border-bottom: 1px solid #ddd;
          padding-bottom: 5px;
        }
    
        /* Payment Method Section */
        .payment-method {
          margin-bottom: 20px;
          font-size: 16px;
        }
    
        /* Table Styling */
        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
          table-layout: fixed;
        }
    
        th,
        td {
          padding: 12px 15px;
          text-align: left;
          border-bottom: 1px solid #ddd;
          word-wrap: break-word;
        }
    
        th {
          background-color: #f2f2f2;
          font-size: 16px;
        }
    
        tr:nth-child(even) {
          background-color: #f9f9f9;
        }
    
        /* Ensure all table headers and data cells within #invoice are left-aligned */
        #invoice table th,
        #invoice table td {
          text-align: left;
        }
    
        /* Additional Comments Section */
        .additional-comments {
          margin-bottom: 20px;
        }
    
        .additional-comments h3 {
          margin-bottom: 10px;
          font-size: 20px;
        }
    
        .additional-comments p {
          font-size: 16px;
          white-space: pre-wrap; /* Preserve line breaks */
        }
    
        /* Terms Section */
        .terms {
          text-align: left;
          margin-bottom: 20px;
        }
    
        .terms h3 {
          margin-bottom: 5px;
          font-size: 16px;
        }
    
        .terms p {
          font-size: 14px;
        }
    
        /* Totals Section */
        .totals {
          margin-top: 30px;
          padding: 20px;
          background-color: #f9f9f9;
          border: 1px solid #ddd;
          border-radius: 5px;
        }
    
        .totals p {
          display: flex;               /* Enable Flexbox */
          justify-content: space-between; /* Space between label and amount */
          align-items: center;         /* Vertical centering */
          font-size: 16px;
          margin-bottom: 10px;
        }
    
        .totals p span {
          text-align: right;
          font-weight: bold;
        }
    
        /* Footer */
        .footer {
          text-align: center;
          color: #666;
          font-size: 14px;
          margin-top: 30px;
        }
    
        /* Button Styles */
        .button-container {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
    
        .action-button {
          background-color: #4a90e2; /* Blue */
          color: white;
          border: none;
          border-radius: 5px;
          padding: 10px 20px;
          font-size: 16px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }

        @media only screen and (max-width: 600px) {
          .action-button {
          background-color: #4a90e2;
          color: white;
          border: none;
          width: 350px;
          height: 150px;
          margin-top: 50px;
          border-radius: 5px;
          padding: 10px 20px;
          font-size: 40px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }
        }

    
        .action-button:hover {
          background-color: #357ABD; /* Darker Blue on Hover */
        }
    
        .action-button:disabled {
          background-color: #aaa;
          cursor: not-allowed;
        }
    
        /* Loading Spinner Styles */
        .spinner {
          border: 4px solid #f3f3f3; /* Light grey */
          border-top: 4px solid #3498db; /* Blue */
          border-radius: 50%;
          width: 20px;
          height: 20px;
          animation: spin 2s linear infinite;
          display: inline-block;
          vertical-align: middle;
          margin-left: 10px;
        }
    
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    
        /* PDF Preview Styles */
        #pdf-preview {
          margin-top: 20px;
          text-align: center;
        }
    
        #pdf-preview a {
          display: inline-block;
          margin-top: 10px;
          text-decoration: none;
          color: #007BFF;
        }
    
        /* Toast Container and Toast Styles */
        .toast-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
    
        .toast {
          background-color: #333;
          color: #fff;
          padding: 10px 15px;
          border-radius: 5px;
          opacity: 0.95;
          font-size: 14px;
          animation: fadeInOut 3s forwards;
        }
    
        .toast.success {
          background-color: #28a745;
        }
    
        .toast.error {
          background-color: #dc3545;
        }
    
        .toast.info {
          background-color: #007bff;
        }
    
        @keyframes fadeInOut {
          0% { opacity: 0; }
          10% { opacity: 0.95; }
          90% { opacity: 0.95; }
          100% { opacity: 0; }
        }
        
        /* Optional: If you want to preserve the layout exactly on very small screens,
           you can remove or comment out responsive media queries that change font sizes or layout. */

           .backButton{
          text-decoration: none; color: #007BFF; font-size: 16px; margin-right: 20px;
        }

        @media only screen and (max-width: 600px) {
          .backButton{
          text-decoration: none; color: #007BFF; font-size: 36px; margin-right: 20px; margin-bottom: 60px;
        }
        }
        
      </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <a href="index.html" class="backButton">&larr; Back to Home</a>
    <div class="container">
        
        <div id="invoice">
            <div class="header">
                <p id="invoice-date">Date: <!-- Dynamic Date --></p>
                <h1>INVOICE</h1>
                <div class="logo"></div>
            </div>

            <div class="company-details">
                <h2 id="company-name">Shans Accessories PTY LTD</h2>
                <p>61 Civin Drive<br>Bedfordview<br>Johannesburg</p>
                <div class="address-contact">
                    <p id="banking-info"></p>
                </div>
                <!-- Reference Number (Non-editable) -->
                <p class="reference-number" id="reference-number">Reference Number: <!-- Dynamic Reference --></p>
            </div>

            <div class="billing-shipping">
                <div class="billing">
                    <h3>BILL TO</h3>
                    <p><!-- Customer Billing Information --></p>
                </div>
                <div class="shipping">
                    <h3>SHIP TO</h3>
                    <p><!-- Customer Shipping Information --></p>
                </div>
            </div>

            <!-- Payment Method Section -->
            <p class="payment-method">Payment Method: <span id="paymentMethod">N/A</span></p>

            <!-- Products Table -->
            <table>
                <thead>
                    <tr id="table-header">
                        <th>Product</th>
                        <th>QTY</th>
                        <th>UNIT PRICE (R)</th>
                        <th>TAX PER UNIT (R)</th>
                        <th>TOTAL (R)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic Product Rows Will Be Inserted Here -->
                </tbody>
            </table>

            <!-- Added Additional Comments Section -->
            <div id="additional-comments" class="additional-comments" style="margin-bottom: 20px;">
                <!-- Additional Comments will be inserted here if available -->
            </div>

            <!-- Added Terms Section -->
            <div class="terms">
                <h3>Terms</h3>
                <p>No refunds or exchanges on correctly supplied items</p>
            </div>

            <!-- Totals Section -->
            <div class="totals">
                <p class="subtotal">Product Amount (Subtotal): <span id="subtotalAmount">R0.00</span></p>
                <p class="tax" id="tax-info" style="display: none;">Tax (15%): <span id="taxAmount">R0.00</span></p>
                <p class="total">Total Amount: <span id="totalAmount">R0.00</span></p>
            </div>
        </div>

        <div class="footer">
            <p>Follow us to see more on</p>
            <p>Instagram: @shans_car_accessories</p>
            <p>Twitter/Pinterest: Shans Accessories</p>
            <p>Facebook: Shans Accessories (By Car Brand)</p>
            <p>YouTube/Tik Tok: Shans Accessories All products are Non OEM</p>
        </div>
    </div>

    <!-- Buttons Container -->
    <div class="button-container">
        <!-- Confirm Button -->
        <button id="confirm-button" class="action-button">Confirm</button>

        <!-- Loading Spinner (Hidden by Default) -->
        <div id="loading-spinner" class="spinner" style="display: none;"></div>
    </div>

    <!-- PDF Preview Section (Optional: Can be repurposed or removed) -->
    <div id="pdf-preview"></div>

    <!-- Include html2pdf.js from CDN (Optional, if using for screenshots) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        /**
         * Display a non-blocking toast message in the top-right corner.
         * @param {string} message - The message to display.
         * @param {string} [type='info'] - The type of the toast ('success', 'error', 'info').
         */
        function showToastMessage(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Automatically remove the toast after ~3s
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Function to retrieve a cookie by name
        function getCookie(name) {
            const cname = name + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const ca = decodedCookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(cname) === 0) {
                    return c.substring(cname.length, c.length);
                }
            }
            return "";
        }

        // Function to format currency in ZAR
        function formatCurrency(amount) {
            return 'R' + parseFloat(amount).toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Function to sanitize HTML to prevent XSS
        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        // Function to format date
        function formatDate(date) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Intl.DateTimeFormat('en-US', options).format(date);
        }

        // Function to generate a random 7-digit reference number
        function generateReferenceNumber() {
            return Math.floor(1000000 + Math.random() * 9000000).toString();
        }

        // Function to populate the invoice with data from cookies
        function populateInvoice() {
            const customerInfoCookie = getCookie('customerInfo');
            const selectedProductsCookie = getCookie('selectedProducts');
            const subtotalAmountCookie = getCookie('subtotalAmount');
            const taxAmountCookie = getCookie('taxAmount');
            const totalAmountCookie = getCookie('totalAmount');
            const selectedCompanyCookie = getCookie('selectedCompany'); // Retrieve company info

            if (!customerInfoCookie || !selectedProductsCookie || !subtotalAmountCookie 
                || !taxAmountCookie || !totalAmountCookie || !selectedCompanyCookie) {
                // Was using alert; now replaced with toast:
                showToastMessage('No invoice data found. Please generate an invoice first.', 'error');
                window.location.href = 'index.html'; 
                return;
            }

            const customerInfo = JSON.parse(customerInfoCookie);
            const selectedProducts = JSON.parse(selectedProductsCookie);
            const subtotalAmount = parseFloat(JSON.parse(subtotalAmountCookie));
            const taxAmount = parseFloat(JSON.parse(taxAmountCookie));
            const totalAmount = parseFloat(JSON.parse(totalAmountCookie));
            const selectedCompany = JSON.parse(selectedCompanyCookie); // Parse company info

            // Populate Company Information
            document.getElementById('company-name').textContent = selectedCompany.name;
            document.getElementById('banking-info').innerHTML = selectedCompany.bankingInformation;

            // Generate and set reference number
            const referenceNumberElement = document.getElementById('reference-number');
            const generatedReference = generateReferenceNumber();
            referenceNumberElement.textContent = 'Reference Number: ' + generatedReference;

            // Populate Billing Information
            const billingElement = document.querySelector('.billing p');
            billingElement.innerHTML = `
                <strong>${sanitizeHTML(customerInfo.billing.name)}</strong><br>
                ${sanitizeHTML(customerInfo.billing.address)}<br>
                Email: ${sanitizeHTML(customerInfo.billing.email)}<br>
                Phone: ${sanitizeHTML(customerInfo.billing.phone)}
            `;

            // Populate Shipping Information
            const shippingElement = document.querySelector('.shipping p');
            if (customerInfo.shipping) {
                shippingElement.innerHTML = `
                    <strong>${sanitizeHTML(customerInfo.shipping.name)}</strong><br>
                    ${sanitizeHTML(customerInfo.shipping.address)}<br>
                    Email: ${sanitizeHTML(customerInfo.shipping.email)}<br>
                    Phone: ${sanitizeHTML(customerInfo.shipping.phone)}
                `;
            } else {
                shippingElement.innerHTML = `Same as billing address`;
            }

            // Handle Tax Column in Table
            const isTaxAdded = taxAmount > 0;
            const tableHeaderRow = document.getElementById('table-header');
            const taxInfo = document.getElementById('tax-info');

            if (isTaxAdded) {
                // Check if TAX PER UNIT (R) column already exists
                if (!tableHeaderRow.querySelector('th:nth-child(4)') 
                    || !tableHeaderRow.querySelector('th:nth-child(4)').textContent.includes('TAX PER UNIT (R)')) {
                    const taxHeader = document.createElement('th');
                    taxHeader.textContent = 'TAX PER UNIT (R)';
                    tableHeaderRow.insertBefore(taxHeader, tableHeaderRow.children[3]);
                }
                taxInfo.style.display = 'flex'; // Ensure display is flex
            } else {
                // Remove TAX PER UNIT (R) column if it exists
                const taxHeader = tableHeaderRow.querySelector('th:nth-child(4)');
                if (taxHeader && taxHeader.textContent.includes('TAX PER UNIT (R)')) {
                    taxHeader.parentNode.removeChild(taxHeader);
                }
                taxInfo.style.display = 'none';
            }

            // Populate Product Rows
            const tbody = document.querySelector('table tbody');
            tbody.innerHTML = ''; 

            selectedProducts.forEach(product => {
                const row = tbody.insertRow();
                const descCell = row.insertCell(0);
                descCell.textContent = product.name;

                const qtyCell = row.insertCell(1);
                qtyCell.textContent = product.quantity;

                const unitPriceCell = row.insertCell(2);
                let unitPriceExcludingTax = product.price;
                let taxPerUnit = 0;

                if (isTaxAdded) {
                    unitPriceExcludingTax = product.price / 1.15;
                    unitPriceCell.textContent = formatCurrency(unitPriceExcludingTax.toFixed(2));
                    taxPerUnit = product.price - unitPriceExcludingTax;
                    const taxCell = row.insertCell(3);
                    taxCell.textContent = formatCurrency(taxPerUnit.toFixed(2));
                    const totalCell = row.insertCell(4);
                    totalCell.textContent = formatCurrency((product.price * product.quantity).toFixed(2));
                } else {
                    unitPriceCell.textContent = formatCurrency(product.price.toFixed(2));
                    const totalCell = row.insertCell(3);
                    totalCell.textContent = formatCurrency((product.price * product.quantity).toFixed(2));
                }
            });

            // Populate Additional Comments
            const comments = customerInfo.comments;
            const commentsDiv = document.getElementById('additional-comments');
            if (comments && comments.trim() !== "") {
                commentsDiv.innerHTML = `
                    <h3>Additional Comments:</h3>
                    <p>${sanitizeHTML(comments).replace(/\n/g, '<br>')}</p>
                `;
                commentsDiv.style.display = 'block';
            } else {
                commentsDiv.style.display = 'none';
            }

            // Populate Totals
            document.getElementById('subtotalAmount').textContent = formatCurrency(subtotalAmount.toFixed(2));
            document.getElementById('taxAmount').textContent = formatCurrency(taxAmount.toFixed(2));
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount.toFixed(2));

            // Populate Payment Method
            const paymentMethodSpan = document.getElementById('paymentMethod');
            paymentMethodSpan.textContent = customerInfo.paymentMethod ? sanitizeHTML(customerInfo.paymentMethod) : 'N/A';

            // Populate Date
            const dateElement = document.getElementById('invoice-date');
            dateElement.textContent = 'Date: ' + formatDate(new Date());
        }

        // Function to confirm and send the invoice
        async function confirmInvoice() {
            const confirmButton = document.getElementById('confirm-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const pdfPreview = document.getElementById('pdf-preview');
            const referenceNumberElement = document.getElementById('reference-number');

            confirmButton.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            pdfPreview.innerHTML = '';

            try {
                const customerInfoCookie = getCookie('customerInfo');
                const selectedProductsCookie = getCookie('selectedProducts');
                const subtotalAmountCookie = getCookie('subtotalAmount');
                const taxAmountCookie = getCookie('taxAmount');
                const totalAmountCookie = getCookie('totalAmount');
                const selectedCompanyCookie = getCookie('selectedCompany');

                if (!customerInfoCookie || !selectedProductsCookie || !subtotalAmountCookie 
                    || !taxAmountCookie || !totalAmountCookie || !selectedCompanyCookie) {
                    throw new Error('No invoice data found.');
                }

                const customerInfo = JSON.parse(customerInfoCookie);
                const selectedProducts = JSON.parse(selectedProductsCookie);
                const subtotalAmount = parseFloat(JSON.parse(subtotalAmountCookie));
                const taxAmount = parseFloat(JSON.parse(taxAmountCookie));
                const totalAmount = parseFloat(JSON.parse(totalAmountCookie));
                const selectedCompany = JSON.parse(selectedCompanyCookie);

                // Retrieve the reference number from the element
                const referenceNumberText = referenceNumberElement.textContent;
                const referenceNumber = referenceNumberText.replace('Reference Number: ', '').trim();

                if (referenceNumber === "") {
                    throw new Error('Reference number is missing.');
                }

                const invoiceData = {
                    date: new Date().toISOString().slice(0,10),
                    referenceNumber: referenceNumber, // Include the reference number
                    billing: customerInfo.billing,
                    shipping: customerInfo.shipping || null,
                    paymentMethod: customerInfo.paymentMethod || 'N/A',
                    comments: customerInfo.comments || "",
                    products: selectedProducts.map(product => ({
                        item_code: product.item_code,
                        name: product.name,
                        quantity: product.quantity,
                        unitPriceExcludingTax: taxAmount > 0 
                            ? parseFloat((product.price / 1.15).toFixed(2))
                            : parseFloat(product.price.toFixed(2)),
                        taxPerUnit: taxAmount > 0
                            ? parseFloat((product.price - (product.price / 1.15)).toFixed(2))
                            : 0.00,
                        totalPrice: parseFloat((product.price * product.quantity).toFixed(2))
                    })),
                    subtotal: parseFloat(subtotalAmount.toFixed(2)),
                    tax: parseFloat(taxAmount.toFixed(2)),
                    total: parseFloat(totalAmount.toFixed(2)),
                    company: {
                        name: selectedCompany.name,
                        bankingInformation: selectedCompany.bankingInformation
                    }
                };

                console.log('Sending invoice data to backend:', invoiceData);

                const response = await fetch('http://localhost:3000/api/generate-invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invoiceData)
                });

                if (!response.ok) {
                    let errorMessage = 'Failed to generate PDF.';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    throw new Error(errorMessage);
                }

                const successData = await response.json();
                console.log('Backend response:', successData);

                // Replaced alert with a success toast
                showToastMessage('Successfully sent, thanks!', 'success');

            } catch (error) {
                console.error('Error generating PDF:', error);
                // Show error toast instead of alert
                showToastMessage(`Error: ${error.message}`, 'error');
            } finally {
                confirmButton.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', populateInvoice);
        document.getElementById('confirm-button').addEventListener('click', confirmInvoice);
    </script>
</body>
</html>
